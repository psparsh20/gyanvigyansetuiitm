<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SchoolAI - Agentic Learning Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <style>
        .typing-indicator { display: none; }
        .is-typing .typing-indicator { display: flex; }
    </style>
</head>
<body class="bg-slate-50 font-sans h-screen flex flex-col overflow-hidden">

    <nav class="bg-indigo-700 text-white p-4 flex justify-between items-center shadow-lg z-10">
        <div class="flex items-center gap-2 text-xl font-bold">
            <i class="fas fa-graduation-cap"></i> School.ai Clone
        </div>
        <div class="flex gap-4">
            <button onclick="switchView('student')" class="px-4 py-2 hover:bg-indigo-600 rounded-lg transition">Student View</button>
            <button onclick="switchView('teacher')" class="px-4 py-2 hover:bg-indigo-600 rounded-lg transition">Teacher Dashboard</button>
        </div>
    </nav>

    <main class="flex-1 flex overflow-hidden">

        <div id="student-view" class="flex-1 flex flex-col w-full h-full">
            <div id="agent-header" class="bg-white border-b p-4 flex items-center justify-between shadow-sm">
                <div class="flex items-center gap-3">
                    <div id="agent-avatar" class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <h2 id="agent-name" class="font-bold">Socratic Sidekick</h2>
                        <p id="agent-role" class="text-xs text-slate-500 italic">Exploring: The Solar System</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleVoice()" id="voice-btn" class="w-10 h-10 rounded-full border border-slate-200 flex items-center justify-center hover:bg-red-50 text-slate-400">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
            </div>

            <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50 scroll-smooth">
                <div class="bg-white border p-4 rounded-xl max-w-2xl shadow-sm text-slate-700">
                    Hello! I'm your learning guide. What part of the solar system should we explore today?
                </div>
            </div>

            <div class="p-6 bg-white border-t">
                <div class="max-w-4xl mx-auto flex gap-4 relative">
                    <div class="typing-indicator absolute -top-8 left-0 text-xs text-slate-400 italic flex items-center gap-2">
                        <div class="flex gap-1">
                            <span class="animate-bounce">.</span><span class="animate-bounce delay-75">.</span><span class="animate-bounce delay-150">.</span>
                        </div>
                        <span id="typing-text">AI is thinking</span>
                    </div>
                    <input type="text" id="user-input" class="flex-1 p-4 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none shadow-inner" placeholder="Ask anything or talk to me...">
                    <button onclick="handleSendMessage()" class="bg-indigo-600 text-white px-8 rounded-xl font-bold hover:bg-indigo-700 transition">Send</button>
                </div>
            </div>
        </div>

        <div id="teacher-view" class="hidden flex-1 p-8 bg-slate-100 overflow-y-auto">
            <h1 class="text-2xl font-bold mb-8 flex items-center gap-3">
                <i class="fas fa-chart-line text-indigo-600"></i> Mission Control: Live Classes
            </h1>
            <div id="teacher-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="p-8 text-center text-slate-400 col-span-full italic">Waiting for students to connect...</div>
            </div>
        </div>

    </main>

    <script>
        // CONFIGURATION
        const OPENAI_KEY = "AIzaSyBSnd-fQQVpSQnEzk3D2Rko3iCB2wjA-X4"; 
        
        // PASTE YOUR FIREBASE CONFIG HERE
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_KEY",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "...",
            appId: "..."
        };

        // Initialize Firebase (Wrapped in try-catch for local testing without key)
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch(e) { console.error("Firebase not initialized"); }

        // STATE
        let currentPersona = "Socratic AI";
        let isHumanMode = false;
        let conversationHistory = [{role: "system", content: "You are a Socratic tutor. Never give answers. Ask questions."}];

        // SPEECH RECOGNITION
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.onresult = (e) => {
            document.getElementById('user-input').value = e.results[0][0].transcript;
            handleSendMessage();
            toggleVoice(false);
        };

        function toggleVoice(start = true) {
            const btn = document.getElementById('voice-btn');
            if(start) {
                recognition.start();
                btn.classList.add('text-red-600', 'animate-pulse', 'border-red-200');
            } else {
                recognition.stop();
                btn.classList.remove('text-red-600', 'animate-pulse', 'border-red-200');
            }
        }

        // AGENTIC LOGIC & OPENAI
        async function handleSendMessage() {
            const inputField = document.getElementById('user-input');
            const text = inputField.value.trim();
            if(!text) return;

            // 1. Update UI
            appendMessage('student', text);
            inputField.value = '';
            document.getElementById('student-view').classList.add('is-typing');

            // 2. Persona Handoff Logic (Phantom Teacher)
            if(text.toLowerCase().includes("i don't know") || text.toLowerCase().includes("help me")) {
                triggerPhantomTeacher();
            }

            // 3. API Call
            conversationHistory.push({role: "user", content: text});
            
            try {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${OPENAI_KEY}` },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: conversationHistory
                    })
                });

                const data = await response.json();
                const aiMsg = data.choices[0].message.content;
                
                // 4. Update UI & History
                document.getElementById('student-view').classList.remove('is-typing');
                appendMessage('ai', aiMsg);
                conversationHistory.push({role: "assistant", content: aiMsg});
                
                // 5. Firebase Update (Live for Dashboard)
                if(db) {
                    db.collection("live_sessions").doc("student_001").set({
                        last_message: aiMsg,
                        status: isHumanMode ? "TEACHER INTERVENED" : "ON TRACK",
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }, {merge: true});
                }

                // TTS
                const utterance = new SpeechSynthesisUtterance(aiMsg);
                window.speechSynthesis.speak(utterance);

            } catch(e) {
                console.error(e);
                document.getElementById('student-view').classList.remove('is-typing');
            }
        }

        function triggerPhantomTeacher() {
            isHumanMode = true;
            document.getElementById('agent-name').innerText = "Mr. Harrison (Live)";
            document.getElementById('agent-role').innerText = "Personalized Instruction";
            document.getElementById('agent-avatar').innerHTML = '<i class="fas fa-user-tie"></i>';
            document.getElementById('agent-avatar').className = "w-10 h-10 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center font-bold";
            document.getElementById('typing-text').innerText = "Mr. Harrison is typing";
            
            conversationHistory[0].content = "You are Mr. Harrison, a real teacher who just joined. Be warm, act like you are watching the screen, and guide the student personally.";
        }

        function appendMessage(role, text) {
            const win = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.className = role === 'ai' ? "bg-white border p-4 rounded-xl max-w-2xl shadow-sm text-slate-700" : "bg-indigo-600 text-white p-4 rounded-xl max-w-xl self-end ml-auto shadow-md";
            div.innerText = text;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        }

        function switchView(view) {
            document.getElementById('student-view').classList.toggle('hidden', view !== 'student');
            document.getElementById('teacher-view').classList.toggle('hidden', view !== 'teacher');
            if(view === 'teacher' && db) listenForStudents();
        }

        function listenForStudents() {
            db.collection("live_sessions").onSnapshot((snapshot) => {
                const grid = document.getElementById('teacher-grid');
                grid.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    grid.innerHTML += `
                        <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-indigo-500">
                            <h3 class="font-bold text-lg mb-2">Student ID: ${doc.id}</h3>
                            <span class="text-[10px] font-bold bg-indigo-50 text-indigo-700 px-2 py-1 rounded-full uppercase">${data.status || 'ACTIVE'}</span>
                            <div class="mt-4 p-3 bg-slate-50 rounded italic text-sm text-slate-500">
                                "${data.last_message ? data.last_message.substring(0, 80) + '...' : 'Starting...'}"
                            </div>
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>
