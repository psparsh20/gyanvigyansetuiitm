<script>
    // Your Key
    const API_KEY = "AIzaSyBSnd-fQQVpSQnEzk3D2Rko3iCB2wjA-X4"; 
    const chat = document.getElementById('chat');
    let isPhantomMode = false;

    async function askAI() {
        const inputField = document.getElementById('input');
        const userText = inputField.value.trim();
        if(!userText) return;

        appendMsg('student', userText);
        inputField.value = '';
        document.getElementById('typing').classList.remove('hidden');

        if(userText.toLowerCase().includes("stuck") || userText.toLowerCase().includes("don't know")) {
            switchToTeacher();
        }

        const sysPrompt = isPhantomMode 
            ? "You are Mr. Harrison, a human physics teacher. Be friendly and warm. Guide the student through Electrostatics."
            : "You are a Socratic Physics tutor. Never give direct answers. Ask questions to help the student learn Electrostatics.";

        try {
            // UPDATED URL: Changed to v1 and refined model string
            const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `${sysPrompt} Student: ${userText}` }] }]
                })
            });

            const data = await response.json();
            
            // Debugging log so you can see details in F12 console
            console.log("Gemini Response:", data);

            if (data.error) {
                throw new Error(data.error.message);
            }

            const aiResponse = data.candidates[0].content.parts[0].text;
            appendMsg('ai', aiResponse);
            
            const speech = new SpeechSynthesisUtterance(aiResponse);
            window.speechSynthesis.speak(speech);

        } catch (err) {
            console.error("Detailed API Error:", err);
            appendMsg('ai', "I'm having trouble connecting! Error: " + err.message);
        } finally {
            document.getElementById('typing').classList.add('hidden');
        }
    }

    function appendMsg(role, text) {
        const div = document.createElement('div');
        div.className = role === 'ai' 
            ? "bg-white p-4 rounded-2xl rounded-tl-none border border-slate-200 shadow-sm max-w-[85%]" 
            : "bg-indigo-600 text-white p-4 rounded-2xl rounded-tr-none self-end ml-auto max-w-[85%] shadow-md";
        div.innerHTML = text.replace(/\n/g, '<br>');
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function switchToTeacher() {
        isPhantomMode = true;
        document.getElementById('name').innerText = "Mr. Harrison (Teacher)";
        document.getElementById('avatar').classList.replace('bg-indigo-600', 'bg-orange-500');
        document.getElementById('avatar').innerHTML = '<i class="fas fa-user-tie"></i>';
    }

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    function startVoice() {
        recognition.start();
        document.getElementById('mic').classList.add('text-indigo-600', 'border-indigo-500');
    }
    recognition.onresult = (e) => {
        document.getElementById('input').value = e.results[0][0].transcript;
        document.getElementById('mic').classList.remove('text-indigo-600', 'border-indigo-500');
        askAI();
    };
</script>
